name: Require Slack Approval

on:
  workflow_dispatch:

jobs:
  request-approval:
    runs-on: ubuntu-latest
    steps:
      - name: Import Secrets
        uses: hashicorp/vault-action@v3
        with:
          url: https://vault.morrislan.net
          method: approle
          roleId: ${{ secrets.VAULT_ROLE_ID }}
          secretId: ${{ secrets.VAULT_SECRET_ID }}
          secrets: |
            secrets/data/gitea slack-bot-token | slack_bot_token ;

      - name: Send Slack Approval Request
        id: slack_notify
        uses: slackapi/slack-github-action@v1
        with:
          channel-id: "C07SE7RT7MG"
          payload: |
            {
              "text": "Approval required for deployment.\nReact with âœ… to approve.",
              "attachments": [
                {
                  "text": "Deployment request for `${{ github.ref }}` by `${{ github.actor }}`",
                  "color": "#FFA500"
                }
              ]
            }
        env:
          SLACK_BOT_TOKEN: $slack_bot_token

  wait-for-approval:
    runs-on: ubuntu-latest
    needs: request-approval
    steps:
      - name: Import Secrets
        uses: hashicorp/vault-action@v3
        with:
          url: https://vault.morrislan.net
          method: approle
          roleId: ${{ secrets.VAULT_ROLE_ID }}
          secretId: ${{ secrets.VAULT_SECRET_ID }}
          secrets: |
            secrets/data/gitea slack-bot-token | slack_bot_token ;
      - name: Wait for Slack Reaction
        id: wait_for_reaction
        run: |
          CHANNEL_ID="C07SE7RT7MG"  # Replace with your Slack channel ID
          MESSAGE_TS=$(jq -r '.message.ts' <<< '${{ steps.slack_notify.outputs.slack-response }}')
          
          echo "Waiting for approval reaction..."
          
          while true; do
            REACTIONS=$(curl -s -H "Authorization: Bearer $slack_bot_token" \
              -H "Content-Type: application/json" \
              "https://slack.com/api/reactions.get?channel=$CHANNEL_ID&timestamp=$MESSAGE_TS")

            if echo "$REACTIONS" | jq -e '.message.reactions[] | select(.name=="white_check_mark")' > /dev/null 2>&1; then
              echo "Approval received!"
              exit 0
            fi

            echo "No approval yet. Sleeping for 30s..."
            sleep 30
          done