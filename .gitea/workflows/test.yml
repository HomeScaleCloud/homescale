name: Require Slack Approval

on:
  push:
    branches:
      - prod

jobs:
  wait-for-approval:
    runs-on: ubuntu-latest
    needs: request-approval
    steps:
      - name: Import Secrets
        uses: hashicorp/vault-action@v3
        with:
          url: https://vault.morrislan.net
          method: approle
          roleId: ${{ secrets.VAULT_ROLE_ID }}
          secretId: ${{ secrets.VAULT_SECRET_ID }}
          secrets: |
            secrets/data/gitea slack-bot-token | SLACK_BOT_TOKEN ;
            
      - name: Send Slack Approval Request
        id: slack_notify
        uses: slackapi/slack-github-action@v1
        with:
          channel-id: "C07SE7RT7MG"
          payload: |
            {
              "text": "Approval required for deployment.\nReact with âœ… to approve.",
              "attachments": [
                {
                  "text": "Deployment request for `${{ github.ref }}` by `${{ github.actor }}`",
                  "color": "#FFA500"
                }
              ]
            }

      - name: Wait for Slack Reaction
        id: wait_for_reaction
        run: |
          CHANNEL_ID="C07SE7RT7MG"  # Replace with your Slack channel ID
          MESSAGE_TS=$(echo '${{ steps.slack_notify.outputs.slack-response }}' | grep -oP '"ts":"\K[^"]*')
          
          echo "Waiting for approval reaction..."
          
          while true; do
            REACTIONS=$(curl -s -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
              -H "Content-Type: application/json" \
              "https://slack.com/api/reactions.get?channel=$CHANNEL_ID&timestamp=$MESSAGE_TS")

            if echo "$REACTIONS" | grep -q '"name":"white_check_mark"'; then
              echo "Approval received!"
              exit 0
            fi

            echo "No approval yet. Sleeping for 30s..."
            sleep 30
          done
