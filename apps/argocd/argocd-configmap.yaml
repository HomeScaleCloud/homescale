apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-cm
  namespace: argocd
  labels:
    app.kubernetes.io/name: argocd-cm
    app.kubernetes.io/part-of: argocd
data:
  resource.exclusions: |
    - apiGroups:
      - cilium.io
      kinds:
      - CiliumIdentity
      clusters:
      - "*"
  url: https://argocd.morrislan.net
  timeout.reconciliation: 45s
  oidc.config: |
    name: authentik
    issuer: https://auth.morrislan.net/application/o/argocd/
    clientID: <path:secrets/data/argocd#oidc-client-id>
    clientSecret: <path:secrets/data/argocd#oidc-client-secret>
    requestedScopes: ["openid", "profile", "email", "groups"]
---
apiVersion: v1
kind: ConfigMap
metadata:
  labels:
    app.kubernetes.io/component: notifications-controller
    app.kubernetes.io/name: argocd-notifications-controller
    app.kubernetes.io/part-of: argocd
  name: argocd-notifications-cm
  namespace: argocd
data:
  subscriptions: |
    - recipients:
      - slack_webhook
      triggers:
      - on-sync-status-unknown
      - on-sync-succeeded
      - on-sync-failed
      - on-sync-error
  service.webhook.slack_webhook: |
    url: <path:secrets/data/argocd#slack-webhook>
    headers:
    - name: Content-Type
      value: application/json

  template.send-slack: |
    webhook:
      slack_webhook:
        method: POST
        body: |
          {
            "attachments": [{
              "title": "{{.app.metadata.name}}",
              "title_link": "https://argocd.morrislan.net/applications/{{.app.metadata.name}}",
              "color": "#18be52",
              "fields": [{
                "title": "Sync Status",
                "value": "{{.app.status.sync.status}}",
                "short": true
              }, {
                "title": "Repository",
                "value": "{{.app.spec.source.repoURL | call .repo.RepoURLToHTTPS}}",
                "short": true
              }]
            }]
          }