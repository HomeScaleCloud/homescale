apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  - ../../../base/manifests
  - pinniped-core-oidc.yaml
  - pinniped-core-secret.yaml
  - pinniped-core-federation.yaml

patches:
  - target:
      group: authentication.concierge.pinniped.dev
      version: v1alpha1
      kind: JWTAuthenticator
      name: supervisor-core
    patch: |-
      - op: add
        path: /spec/audience
        value: core

  - target:
      group: argoproj.io
      version: v1alpha1
      kind: Application
      name: pinniped-helm
    patch: |-
      - op: replace
        path: /spec/sources/0/helm/valuesObject/supervisor
        value:
          enabled: true
          service:
            public:
              type: ClusterIP
          ingress:
            enabled: true
            ingressClassName: nginx
            hostname: auth.k8s.api.homescale.cloud
            path: /
            annotations:
              cert-manager.io/cluster-issuer: letsencrypt
              nginx.ingress.kubernetes.io/backend-protocol: "HTTPS"
              nginx.ingress.kubernetes.io/ssl-passthrough: "true"
            tls: true
