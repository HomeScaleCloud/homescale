apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ../../../../apps/argocd
  - ../../../../apps/cert-manager
  - ../../../../apps/crossplane
  - ../../../../apps/external-dns
  - ../../../../apps/generic-device-plugin
  - ../../../../apps/ingress-nginx
  - ../../../../apps/metrics
  - ../../../../apps/omni
  - ../../../../apps/onepassword
  - ../../../../apps/tailscale
  - ../../../../apps/teleport/teleport-cluster
  - argocd-lon1-core-argocd.yaml
  - argocd-lon1-core-service.yaml
  - argocd-lon1-core-certificate.yaml
  - argocd-lon1-core-secret.yaml
patches:
  - target:
      kind: ConfigMap
      name: argocd-cm
    patch: |-
      - op: add
        path: /data/url
        value: https://argocd.core.lon1.homescale.cloud
      - op: add
        path: /data/dex.config
        value: |
          connectors:
            - type: github
              id: github
              name: GitHub
              config:
                clientID: <path:vaults/lon1-core/items/argocd#oidc-client-id>
                clientSecret: <path:vaults/lon1-core/items/argocd#oidc-client-secret>
                orgs:
                - name: HomeScale
  - target:
      kind: ConfigMap
      name: argocd-notifications-cm
    patch: |-
      - op: add
        path: /data/service.slack
        value: |
          service.slack: |
            token: <path:vaults/lon1-core/items/argocd#slack-token>
  - target:
      kind: OnePasswordItem
      name: op-onepassword
    patch: |-
      - op: add
        path: /spec/itemPath
        value: "vaults/lon1-core/items/onepassword"
  - target:
      kind: Application
      name: tailscale
    patch: |-
      - op: add
        path: /spec/sources/0/helm/valuesObject
        value:
          proxyConfig:
            defaultTags: "tag:lon1-core"
          operatorConfig:
            hostname: lon1-core
            defaultTags:
              - "tag:lon1-core"
          oauth:
            clientId: <path:vaults/lon1-core/items/tailscale#oauth-client-id>
            clientSecret: <path:vaults/lon1-core/items/tailscale#oauth-client-secret>
  - target:
      kind: Application
      name: teleport-cluster
    patch: |-
      - op: add
        path: /spec/sources/0/helm/valuesObject/labels
        value:
          region: lon1
          platform: doks
      - op: add
        path: /spec/sources/0/helm/valuesObject/annotations/service/tailscale.com~1tags
        value: "tag:lon1-core,tag:admin-app"
