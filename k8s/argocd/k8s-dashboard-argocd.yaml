apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: k8s-dashboard
  namespace: argocd
spec:
  project: default
  sources:
    - repoURL: https://kubernetes.github.io/dashboard/
      chart: kubernetes-dashboard
      targetRevision: 7.10.0
      helm:
        valuesObject: {}
    - repoURL: https://oauth2-proxy.github.io/manifests
      chart: oauth2-proxy
      targetRevision: 7.8.0
      plugin:
        env:
          - name: AVP_TYPE
            value: vault
          - name: VAULT_ADDR
            value: http://vault.vault.svc:8200
          - name: AVP_AUTH_TYPE
            value: k8s
          - name: AVP_K8S_ROLE
            value: k8s-dashboard
          - name: HELM_VALUES
            value: |
              config:
                clientID: "<path:secrets/data/k8s-dashboard#oidc-client-id>"
                clientSecret: "<path:secrets/data/k8s-dashboard#oidc-client-secret>"
                cookieSecret: "<path:secrets/data/k8s-dashboard#oidc-cookie-secret>"
              extraArgs:
                provider: oidc
                provider-display-name: "MorrisLAN SSO"
                redirect-url: https://k8s-dashboard.morrislan.net/callback
                cookie-secure: false
                oidc-issuer-url: "https://auth.morrislan.net/application/o/k8s-dashboard/"
                allowed-group: Admins
                upstream: "http://k8s-dashboard.morrislan.net"
                email-domain: "*"
                set-authorization-header: true
  destination:
    server: https://kubernetes.default.svc
    namespace: k8s-dashboard
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
