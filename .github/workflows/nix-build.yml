name: "Nix Build"
on:
  workflow_dispatch:
      
jobs:
  build-srv-cfzt-01:
    name: Build NixOS for `srv-cfzt-01`
    runs-on: ubuntu-22.04
    steps:
    - uses: actions/checkout@v3.5.3
    - name: Inject secrets in .nix files
      run: sed -i "s/TOKEN_PLACEHOLDER/${{ secrets.CFZT_MORRISLAN_TUNNEL_TOKEN }}/" ./nix/srv-cfzt-01/configuration.nix
    - uses: cachix/install-nix-action@v24
      with:
        nix_path: nixpkgs=channel:nixos-23.11
        extra_nix_config: |
          extra-platforms = aarch64-linux
    - name: "Install QEMU"
      run: sudo apt -y install qemu-user-static
    - name: Test aarch64 binfmt emulation
      run: |
        cat /proc/sys/fs/binfmt_misc/qemu-aarch64
        /usr/bin/qemu-aarch64-static --version
    - name: Build image
      run: |
        nix-build '<nixpkgs/nixos>'  \
          -A config.system.build.sdImage \
          -I nixos-config=./nix/srv-cfzt-01/configuration.sdImage.nix \
          --argstr system aarch64-linux \
          --option sandbox false
    - name: Upload image
      uses: actions/upload-artifact@v3
      with:
        name: srv-cfzt-01
        path: ./result/sd-image/*.img*

  build-srv-tp-01:
    name: Build NixOS for `srv-tp-01`
    runs-on: ubuntu-22.04
    steps:
    - uses: actions/checkout@v3.5.3
    - name: Inject secrets in .nix files
      run: sed -i "s/TOKEN_PLACEHOLDER/${{ secrets.CFZT_MORRISLAN_TUNNEL_TOKEN }}/" ./nix/srv-tp-01/configuration.nix
    - name: "Setup Nix"
      uses: cachix/install-nix-action@v24
      with:
        nix_path: nixpkgs=channel:nixos-23.11
        extra_nix_config: |
          extra-platforms = x86_64-linux
    - name: Build image
      run: |
        nix-build '<nixpkgs/nixos>'  \
          -A config.system.build.sdImage \
          -I nixos-config=./nix/srv-tp-01/configuration.sdImage.nix \
          --argstr system x86_64-linux \
          --option sandbox false
    - name: Set up doctl
      uses: digitalocean/action-doctl@v2
      with:
       token: ${{ secrets.DO_TOKEN }}

    - name: Upload Custom Droplet Image
      run: |
        doctl compute image create nixos-srv-tp-01 --image ./result/sd-image/*.img --region lon1
