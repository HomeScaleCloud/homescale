name: "CI"
permissions:
  contents: read
  packages: write
  id-token: write

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}

jobs:
  pre-commit:
    name: "pre-commit"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
      - uses: pre-commit/action@v3.0.1
      - uses: pre-commit-ci/lite-action@v1.1.0
        if: always()

  discover:
    name: "Discover build targets"
    needs: pre-commit
    runs-on: ubuntu-latest
    outputs:
      docker: ${{ steps.set.outputs.docker }}
      helm: ${{ steps.set.outputs.helm }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Find Docker & Helm targets
        id: set
        shell: bash
        run: |
          set -euo pipefail
          # Find Dockerfiles under apps/** (supports apps/foo/src/Dockerfile or apps/foo/Dockerfile)
          docker_json='[]'
          while IFS= read -r df; do
            dir="$(dirname "$df")"
            base="$(basename "$dir")"
            if [[ "$base" == "src" ]]; then
              name="$(basename "$(dirname "$dir")")"
              context="$dir"
            else
              name="$(basename "$dir")"
              context="$dir"
            fi
            docker_json="$(jq --arg n "$name" --arg c "$context" '. + [{name:$n, context:$c}]' <<<"$docker_json")"
          done < <(find apps -type f -iname Dockerfile | sort)

          # Find Helm charts as any apps/*/Chart.yaml (and apps/*/charts/<subchart>/Chart.yaml ignored)
          helm_json='[]'
          while IFS= read -r chart; do
            chart_dir="$(dirname "$chart")"
            # app name is the directory containing Chart.yaml
            name="$(basename "$chart_dir")"
            helm_json="$(jq --arg n "$name" --arg p "$chart_dir" '. + [{name:$n, path:$p}]' <<<"$helm_json")"
          done < <(find apps -maxdepth 2 -type f -name Chart.yaml | sort)
          echo "docker=$(jq -c . <<<"$docker_json")" >> "$GITHUB_OUTPUT"
          echo "helm=$(jq -c . <<<"$helm_json")" >> "$GITHUB_OUTPUT"

  build-docker:
    name: "Build - Docker - ${{ matrix.name }}"
    needs: [discover]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.discover.outputs.docker) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login to ghcr (Docker)
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get image tags
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/homescalecloud/${{ matrix.name }}
          tags: |
            type=raw,value=${{ github.sha }}
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: ${{ matrix.context }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          platforms: linux/amd64

  build-helm:
    name: "Build - Helm â€“ ${{ matrix.name }}"
    needs: [discover, build-docker]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.discover.outputs.helm) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.18.6
      - name: Login to ghcr (Docker)
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Login to ghcr (Helm OCI)
        shell: bash
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ghcr.io --username "${{ github.actor }}" --password-stdin
      - name: Get Helm dependencies
        run: |
          helm dependency build "${{ matrix.path }}"
      - name: Package Helm chart
        run: |
          helm package "${{ matrix.path }}"
      - name: Upload chart artifacts
        uses: actions/upload-artifact@v4
        with:
          name: helm-${{ matrix.name }}
          path: ./${{ matrix.name }}-*.tgz
          if-no-files-found: error
      - name: Push Helm chart (main only)
        if: github.ref == 'refs/heads/main'
        shell: bash
        run: |
          # Derive version without needing yq installed
          CHART_VERSION="$(helm show chart "${{ matrix.path }}" | awk '/^version:/{print $2}')"
          helm push "${{ matrix.name }}-${CHART_VERSION}.tgz" oci://ghcr.io/homescalecloud/helm

  deploy-terraform:
    name: "Deploy - Terraform"
    runs-on: ubuntu-latest
    needs:
      - build-docker
      - build-helm
    defaults:
      run:
        shell: bash
        working-directory: ./infra/terraform
    env:
      TF_IN_AUTOMATION: "true"
      TF_INPUT: "false"
      TF_VAR_op_service_account_token: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Import Secrets
        uses: 1password/load-secrets-action@v2
        with:
          export-env: true
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
          TF_TOKEN_app_terraform_io: op://github-actions/terraform-cloud/credential
          TS_ID: op://github-actions/tailscale/username
          TS_SECRET: op://github-actions/tailscale/password  # pragma: allowlist secret
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
      - name: Initialize
        id: init
        run: terraform init
      - name: Validate
        id: validate
        run: terraform validate
      - name: Connect to Tailscale
        uses: tailscale/github-action@v3
        with:
          oauth-client-id: $TS_ID
          oauth-secret: $TS_SECRET
          tags: tag:github-actions
      - name: Plan
        id: plan
        run: terraform plan -out=tfplan
      - name: Apply
        if: github.ref == 'refs/heads/main'
        run: terraform apply -auto-approve tfplan
