version: 38
jobs:
- name: github-mirror
  steps:
  - !CheckoutStep
    name: checkout
    cloneCredential: !DefaultCredential {}
    withLfs: true
    withSubmodules: true
    condition: ALL_PREVIOUS_STEPS_WERE_SUCCESSFUL
  - !PushRepository
    name: push-to-github
    remoteUrl: https://github.com/MorrisLAN/morrislan
    passwordSecret: github-pat
    force: false
    condition: ALL_PREVIOUS_STEPS_WERE_SUCCESSFUL
  triggers:
  - !BranchUpdateTrigger
    branches: prod
  retryCondition: never
  maxRetries: 3
  retryDelay: 30
  timeout: 14400
- name: terraform-plan
  steps:
  - !CheckoutStep
    name: checkout
    cloneCredential: !DefaultCredential {}
    withLfs: true
    withSubmodules: true
    condition: ALL_PREVIOUS_STEPS_WERE_SUCCESSFUL
  - !CommandStep
    name: terraform-init
    runInContainer: true
    image: hashicorp/terraform:1.10
    interpreter: !DefaultInterpreter
      commands: |
        cd terraform
        terraform init
    envVars:
    - name: TF_TOKEN_app_terraform_io
      value: '@secret:tf-token@'
    useTTY: true
    condition: ALL_PREVIOUS_STEPS_WERE_SUCCESSFUL
  - !CommandStep
    name: terraform-plan
    runInContainer: true
    image: hashicorp/terraform:1.10
    interpreter: !DefaultInterpreter
      commands: |
        cd terraform
        terraform plan
    envVars:
    - name: TF_TOKEN_app_terraform_io
      value: '@secret:tf-token@'
    useTTY: true
    condition: ALL_PREVIOUS_STEPS_WERE_SUCCESSFUL
  retryCondition: never
  maxRetries: 3
  retryDelay: 30
  timeout: 14400
