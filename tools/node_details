#!/usr/bin/env bash
# Get useful information about HomeScale nodes/Omni machines in useful formats.
# Mostly LLM drivel but shockingly functional.
set -euo pipefail

LABEL_FILTER=""
OUTPUT_FORMAT="table"
SEARCH_TERM=""
SCRIPT_NAME=$(basename "$0")

print_help() {
  cat <<EOF
Usage: $SCRIPT_NAME [options]

Options:
  -l, --labels     Filter by label(s), e.g., platform=metal,cluster=manor
  -o, --output     Output format: table (default), json, yaml
  --search         Search by machine UUID or node name
  -h, --help       Show this help message
EOF
}

# Parse args
while [[ $# -gt 0 ]]; do
  case $1 in
    -l|--labels)
      LABEL_FILTER="$2"
      shift 2
      ;;
    -o|--output)
      OUTPUT_FORMAT="$2"
      shift 2
      ;;
    --search)
      SEARCH_TERM="$2"
      shift 2
      ;;
    -h|--help)
      print_help
      exit 0
      ;;
    *)
      echo "Unknown argument: $1" >&2
      exit 1
      ;;
  esac
done

raw_json=$(omnictl get machinestatus -o json)

flat_json=$(echo "$raw_json" | jq '
  .items // [.] | map({
    id: .metadata.id,
    node: (.spec.network.hostname // "unknown"),
    infra: (.metadata.labels["omni.sidero.dev/infra-provider-id"] // "unknown"),
    zone: (
      (.metadata.labels | to_entries | map(select(.key|test("/zone$"))) | .[0].value) // "unknown"
    ),
    region: (
      (.metadata.labels | to_entries | map(select(.key|test("/region$"))) | .[0].value) // "unknown"
    ),
    bmc: "UNKNOWN_BMC",
    cluster: (.spec.cluster // "unknown"),
    platform: (.metadata.labels["omni.sidero.dev/platform"] // "unknown"),
    version: (.spec.talosversion // "unknown")
  })')

# Apply label filter
filtered_json="$flat_json"

if [[ -n "$LABEL_FILTER" ]]; then
  jq_filter=".[]"
  IFS=',' read -ra filters <<< "$LABEL_FILTER"
  for filter in "${filters[@]}"; do
    key="${filter%%=*}"
    val="${filter#*=}"
    jq_filter+=" | select(.$key == \"$val\")"
  done
  filtered_json=$(echo "$flat_json" | jq -c "[ $jq_filter ]")
fi

# Apply search filter
if [[ -n "$SEARCH_TERM" ]]; then
  filtered_json=$(echo "$flat_json" | jq -c "[ .[] | select(.id == \"$SEARCH_TERM\" or .node == \"$SEARCH_TERM\") ]")
fi

# Output
case "$OUTPUT_FORMAT" in
  json)
    echo "$filtered_json" | jq .
    ;;
  yaml)
    if command -v yq &>/dev/null; then
      echo "$filtered_json" | yq -y
    else
      echo "yq not found. Please install Python yq (https://github.com/kislyuk/yq) for YAML output." >&2
      exit 1
    fi
    ;;
  table)
    printf "%-36s %-20s %-14s %-8s %-8s %-18s %-10s %-10s %-8s\n" \
      "MACHINE-ID" "NODE" "INFRA" "ZONE" "REGION" "BMC-ADDRESS" "CLUSTER" "PLATFORM" "VERSION"
    echo "$filtered_json" |
      jq -r '.[] | [
        .id,
        .node,
        .infra,
        .zone,
        .region,
        .bmc,
        .cluster,
        .platform,
        .version
      ] | @tsv' |
      awk -F'\t' '{ printf "%-36s %-20s %-14s %-8s %-8s %-18s %-10s %-10s %-8s\n", $1,$2,$3,$4,$5,$6,$7,$8,$9 }'
    ;;
  *)
    echo "Unknown output format: $OUTPUT_FORMAT" >&2
    exit 1
    ;;
esac
